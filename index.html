<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cohort Power Mapping</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f9fafb;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 40px;
        }

        h1 { color: #1f2937; font-size: 2rem; margin-bottom: 4px; }
        .subtitle { color: #6b7280; margin-bottom: 4px; }
        .count-label { color: #9ca3af; font-size: 0.85rem; margin-bottom: 24px; }

        .info-box {
            background: #e8edf7;
            border-left: 4px solid #081F5D;
            padding: 16px;
            margin-bottom: 24px;
            font-size: 0.9rem;
            color: #374151;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 0;
            margin-bottom: 32px;
            border-bottom: 2px solid #e5e7eb;
        }
        .tab-btn {
            padding: 12px 24px;
            border: none;
            border-bottom: 3px solid transparent;
            background: none;
            color: #6b7280;
            font-weight: 500;
            font-size: 0.95rem;
            cursor: pointer;
            margin-bottom: -2px;
            transition: all 0.15s;
        }
        .tab-btn.active {
            border-bottom-color: #081F5D;
            color: #081F5D;
            font-weight: 700;
        }

        /* Power grid */
        .power-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 28px;
        }
        .power-btn {
            padding: 16px 12px;
            border: 3px solid #e5e7eb;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            text-align: center;
            transition: all 0.15s;
        }
        .power-btn:hover:not(.disabled) {
            transform: scale(1.02);
            box-shadow: 0 4px 8px rgba(0,0,0,0.08);
        }
        .power-btn.selected { background: var(--power-bg); border-color: var(--power-color); }
        .power-btn.disabled { opacity: 0.4; cursor: not-allowed; }
        .power-dot {
            width: 12px; height: 12px; border-radius: 50%;
            margin: 0 auto 8px;
        }
        .power-btn-name { font-weight: 600; font-size: 0.85rem; color: #1f2937; margin-bottom: 4px; }
        .power-btn-desc { font-size: 0.7rem; color: #6b7280; line-height: 1.4; }

        /* Ranking */
        .rank-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border: 2px solid;
            border-radius: 8px;
            margin-bottom: 8px;
        }
        .rank-number {
            width: 28px; height: 28px; border-radius: 50%;
            background: #081F5D; color: white;
            display: flex; align-items: center; justify-content: center;
            font-weight: 700; font-size: 0.85rem; flex-shrink: 0;
        }
        .rank-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
        .rank-name { flex: 1; font-weight: 600; font-size: 0.9rem; color: #1f2937; }
        .rank-arrows { display: flex; gap: 4px; }
        .arrow-btn {
            width: 28px; height: 28px;
            border: 1px solid #d1d5db; border-radius: 6px;
            background: white; cursor: pointer; font-size: 0.8rem;
            display: flex; align-items: center; justify-content: center;
        }
        .arrow-btn:disabled { opacity: 0.3; cursor: not-allowed; }

        /* Submit button */
        .submit-btn {
            width: 100%; padding: 16px;
            background: #081F5D; color: white;
            border: none; border-radius: 8px;
            font-size: 1rem; font-weight: 600; cursor: pointer;
            transition: all 0.15s;
        }
        .submit-btn:disabled { background: #9ca3af; cursor: not-allowed; }
        .submit-btn:not(:disabled):hover { background: #05163d; }

        /* Results bars */
        .result-bar-card {
            margin-bottom: 16px;
            padding: 16px 20px;
            border: 2px solid;
            border-radius: 8px;
        }
        .result-bar-header {
            display: flex; justify-content: space-between;
            align-items: center; margin-bottom: 8px;
        }
        .result-bar-name { display: flex; align-items: center; gap: 10px; }
        .result-bar-name span:first-child {
            width: 12px; height: 12px; border-radius: 50%; display: inline-block;
        }
        .result-bar-name span:last-child { font-weight: 600; color: #1f2937; font-size: 0.95rem; }
        .result-bar-score { text-align: right; }
        .result-bar-score strong { font-size: 1.3rem; color: #1f2937; }
        .result-bar-score span { font-size: 0.8rem; color: #6b7280; }
        .result-bar-track {
            height: 8px; background: #e5e7eb;
            border-radius: 4px; overflow: hidden;
        }
        .result-bar-fill {
            height: 100%; border-radius: 4px;
            transition: width 0.5s ease;
        }

        /* Table */
        .submissions-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .submissions-table th {
            text-align: left; padding: 10px 12px;
            border-bottom: 2px solid #e5e7eb;
            color: #374151; font-weight: 600; background: #f9fafb;
        }
        .submissions-table td {
            padding: 10px 12px; border-bottom: 1px solid #f3f4f6;
        }
        .table-dot {
            width: 8px; height: 8px; border-radius: 50%;
            display: inline-block; margin-right: 6px;
        }

        /* Reflection box */
        .reflection-box {
            background: #fffbeb; border: 1px solid #fde68a;
            border-radius: 8px; padding: 24px; margin-top: 36px;
        }
        .reflection-box h3 { font-size: 1.125rem; font-weight: 600; color: #1f2937; margin-bottom: 12px; }
        .reflection-box ul { list-style: none; padding: 0; }
        .reflection-box li { color: #374151; margin-bottom: 8px; font-size: 0.9rem; display: flex; }
        .reflection-box li:before { content: "‚Ä¢"; margin-right: 8px; }

        /* Confirmation */
        .confirm-icon {
            width: 64px; height: 64px; border-radius: 50%;
            background: #e8edf7; display: flex;
            align-items: center; justify-content: center;
            margin: 0 auto 20px; font-size: 1.8rem;
        }

        /* Admin */
        .admin-stat {
            padding: 20px 24px; background: #f9fafb;
            border-radius: 8px; border: 1px solid #e5e7eb;
            flex: 1; min-width: 150px;
        }
        .admin-stat-number { font-size: 2rem; font-weight: 700; color: #081F5D; }
        .admin-stat-label { font-size: 0.85rem; color: #6b7280; }
        .admin-btn {
            padding: 12px 24px; color: white; border: none;
            border-radius: 8px; font-size: 0.9rem; font-weight: 600; cursor: pointer;
        }

        /* Password */
        .pw-input {
            width: 100%; padding: 12px 16px;
            border: 2px solid #e5e7eb; border-radius: 8px;
            font-size: 1rem; outline: none; margin-bottom: 12px; text-align: center;
        }
        .pw-input:focus { border-color: #081F5D; }

        .error-msg { color: #ef4444; font-size: 0.875rem; margin-bottom: 16px; font-weight: 500; }
        .loading-spinner {
            width: 40px; height: 40px;
            border: 3px solid #e5e7eb; border-top: 3px solid #081F5D;
            border-radius: 50%; animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .hidden { display: none; }

        @media (max-width: 768px) {
            body { padding: 10px; }
            .container { padding: 20px; }
            h1 { font-size: 1.5rem; }
            .power-grid { grid-template-columns: repeat(2, 1fr); }
            .tab-btn { padding: 10px 16px; font-size: 0.85rem; }
        }
    </style>
</head>
<body>
<div class="container">
    <h1>Cohort Power Mapping</h1>
    <p class="subtitle">Based on French & Raven's Bases of Social Power, with contemporary additions</p>
    <p class="count-label"><span id="submission-count">0</span> of 35 leaders submitted</p>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('submit')">Submit</button>
        <button class="tab-btn" onclick="switchTab('results')" id="results-tab-btn">Cohort Map (<span id="tab-count">0</span>)</button>
        <button class="tab-btn" onclick="switchTab('admin')">Admin</button>
    </div>

    <!-- ==================== SUBMIT TAB ==================== -->
    <div id="tab-submit">
        <div id="submit-form">
            <div class="info-box">
                Based on your individual Power Perception Assessment results, select the <strong>top 3 power types</strong> you most identify with and rank them in order (1 = strongest).
            </div>

            <div style="margin-bottom: 8px;">
                <label style="font-weight: 600; color: #374151; font-size: 0.9rem;">
                    Select Your Top 3 Power Types <span style="font-weight: 400; color: #9ca3af;" id="select-count">(0/3)</span>
                </label>
                <p style="color: #6b7280; font-size: 0.8rem; margin-top: 4px; margin-bottom: 16px;">Click to select, then rank them below</p>
            </div>

            <div class="power-grid" id="power-grid"></div>

            <div id="ranking-section" class="hidden">
                <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 12px; font-size: 0.9rem;">
                    Rank Your Selections (use arrows to reorder)
                </label>
                <div id="ranking-list"></div>
                <p style="font-size: 0.75rem; color: #9ca3af; margin-top: 4px; margin-bottom: 28px;">
                    #1 = 3 points, #2 = 2 points, #3 = 1 point toward cohort weighted score
                </p>
            </div>

            <div id="error-box" class="error-msg hidden"></div>

            <button class="submit-btn" id="submit-btn" disabled onclick="handleSubmit()">Submit My Top 3</button>
        </div>

        <div id="submit-confirm" class="hidden" style="text-align: center; padding: 48px 0;">
            <div class="confirm-icon">‚úì</div>
            <h2 style="color: #1f2937; margin-bottom: 8px;">Submitted!</h2>
            <p style="color: #6b7280; margin-bottom: 8px;">Thank you! Your top 3 have been recorded.</p>
            <p style="color: #6b7280; font-size: 0.85rem; margin-bottom: 24px;" id="confirm-summary"></p>
            <button class="submit-btn" style="width: auto; padding: 12px 32px;" onclick="switchTab('results')">View Cohort Map ‚Üí</button>
        </div>
    </div>

    <!-- ==================== RESULTS TAB ==================== -->
    <div id="tab-results" class="hidden">
        <div id="results-empty" class="hidden" style="text-align: center; padding: 48px 0; color: #6b7280;">
            <p style="font-size: 1.1rem; margin-bottom: 8px;">No submissions yet</p>
            <p style="font-size: 0.85rem;">Once leaders submit their top 3, the cohort map will appear here.</p>
        </div>

        <div id="results-content" class="hidden">
            <div style="margin-bottom: 40px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                    <h3 style="color: #374151; font-size: 1.125rem;">Cohort Power Map</h3>
                    <button class="admin-btn" style="background: #081F5D; font-size: 0.8rem; padding: 8px 16px;" onclick="loadSubmissions()">üîÑ Refresh</button>
                </div>
                <p style="color: #9ca3af; font-size: 0.8rem; margin-bottom: 16px;">Weighted scores: #1 pick = 3pts, #2 = 2pts, #3 = 1pt</p>
                <div style="width: 100%; overflow-x: auto;">
                    <canvas id="radarChart" width="500" height="500" style="display: block; margin: 0 auto; max-width: 500px; width: 100%;"></canvas>
                </div>
            </div>

            <h3 style="color: #374151; margin-bottom: 16px; font-size: 1.125rem;">Weighted Scores (Ranked)</h3>
            <div id="bars-container"></div>

            <h3 style="color: #374151; margin-bottom: 12px; margin-top: 36px; font-size: 1.125rem;">Individual Submissions</h3>
            <div style="overflow-x: auto;">
                <table class="submissions-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>#1 (3pts)</th>
                            <th>#2 (2pts)</th>
                            <th>#3 (1pt)</th>
                        </tr>
                    </thead>
                    <tbody id="submissions-tbody"></tbody>
                </table>
            </div>

            <div class="reflection-box">
                <h3>Cohort Reflection Questions</h3>
                <ul>
                    <li>Which power types dominate our cohort? What does this say about our collective leadership style?</li>
                    <li>Which power types are underrepresented? What blind spots might this create?</li>
                    <li>How might we leverage our diverse power profiles to complement each other?</li>
                    <li>What surprised you about the cohort's overall power distribution?</li>
                    <li>How could we intentionally develop the power types that are less present in our group?</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- ==================== ADMIN TAB ==================== -->
    <div id="tab-admin" class="hidden">
        <div id="admin-lock" style="text-align: center; padding: 48px 0;">
            <div class="confirm-icon">üîí</div>
            <h2 style="color: #1f2937; margin-bottom: 8px;">Admin Access</h2>
            <p style="color: #6b7280; margin-bottom: 24px; font-size: 0.9rem;">Enter the facilitator password to continue.</p>
            <div style="max-width: 300px; margin: 0 auto;">
                <input type="password" class="pw-input" id="admin-pw" placeholder="Enter password"
                    onkeydown="if(event.key==='Enter') unlockAdmin()">
                <div id="admin-pw-error" class="error-msg hidden"></div>
                <button class="submit-btn" onclick="unlockAdmin()">Unlock</button>
            </div>
        </div>

        <div id="admin-panel" class="hidden">
            <div class="info-box">
                <strong>Facilitator Controls</strong> ‚Äî Use this tab to manage submissions. The reset button will clear all data.
            </div>

            <div style="display: flex; gap: 16px; margin-bottom: 32px; flex-wrap: wrap;">
                <div class="admin-stat">
                    <div class="admin-stat-number" id="admin-count">0</div>
                    <div class="admin-stat-label">Submissions</div>
                </div>
                <div class="admin-stat">
                    <div class="admin-stat-number" id="admin-remaining">35</div>
                    <div class="admin-stat-label">Remaining</div>
                </div>
            </div>

            <button class="admin-btn" style="background: #081F5D; margin-right: 12px;" onclick="loadSubmissions()">üîÑ Refresh Data</button>
            <button class="admin-btn" style="background: #ef4444;" onclick="handleReset()">üóëÔ∏è Reset All Submissions</button>

            <div id="admin-list" style="margin-top: 32px;"></div>
        </div>
    </div>
</div>

<script>
// =====================================================================
// CONFIG ‚Äî Replace this URL with your deployed Apps Script Web App URL
// =====================================================================
const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwEb2PJEjKvZaZ_HhbZBsj-uPSAXPabbSi7mLy8324PNXvZEGuopWI8XmyYF7CL_cwVMA/exec";

// =====================================================================
// POWER TYPES
// =====================================================================
const POWER_TYPES = [
    { id: "legitimate", name: "Legitimate Power", short: "Legitimate", description: "Power derived from your formal position, role, or title", color: "#3b82f6" },
    { id: "reward", name: "Reward Power", short: "Reward", description: "Power to provide benefits, recognition, or positive outcomes", color: "#10b981" },
    { id: "coercive", name: "Coercive Power", short: "Coercive", description: "Power to impose penalties, consequences, or sanctions", color: "#ef4444" },
    { id: "expert", name: "Expert Power", short: "Expert", description: "Power based on knowledge, skills, or specialized expertise", color: "#8b5cf6" },
    { id: "referent", name: "Referent Power", short: "Referent", description: "Power from personal characteristics, charisma, or relationships", color: "#f59e0b" },
    { id: "informational", name: "Informational Power", short: "Informational", description: "Power from access to or control of important information", color: "#06b6d4" },
    { id: "charismatic", name: "Charismatic Power", short: "Charismatic", description: "Power derived from exceptional personal qualities that inspire devotion", color: "#ec4899" },
    { id: "moral", name: "Moral Power", short: "Moral", description: "Power from being perceived as ethically sound and morally credible", color: "#14b8a6" },
    { id: "convening", name: "Convening Power", short: "Convening", description: "Power to bring diverse stakeholders together and facilitate collaboration", color: "#a855f7" }
];

// =====================================================================
// STATE
// =====================================================================
let selected = [];
let ranked = [];
let submissions = [];
let submitted = false;
let adminUnlocked = false;

// =====================================================================
// INIT
// =====================================================================
window.addEventListener("DOMContentLoaded", () => {
    renderPowerGrid();
    loadSubmissions();
});

// =====================================================================
// TABS
// =====================================================================
function switchTab(tab) {
    document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
    document.querySelectorAll("[id^='tab-']").forEach(el => {
        if (el.id.startsWith("tab-")) el.classList.add("hidden");
    });
    event.target.classList.add("active");
    // Also handle if child element was clicked
    document.querySelectorAll(".tab-btn").forEach(b => {
        if (b.textContent.toLowerCase().includes(tab) || b.getAttribute("onclick")?.includes(tab)) {
            b.classList.add("active");
        }
    });
    document.getElementById("tab-" + tab).classList.remove("hidden");

    if (tab === "results") loadSubmissions();
}

// =====================================================================
// POWER GRID RENDER
// =====================================================================
function renderPowerGrid() {
    const grid = document.getElementById("power-grid");
    grid.innerHTML = POWER_TYPES.map(p => `
        <div class="power-btn" id="pbtn-${p.id}"
            style="--power-color: ${p.color}; --power-bg: ${p.color}10;"
            onclick="togglePower('${p.id}')">
            <div class="power-dot" style="background: ${p.color};"></div>
            <div class="power-btn-name">${p.short}</div>
            <div class="power-btn-desc">${p.description.slice(0, 60)}...</div>
        </div>
    `).join("");
}

function togglePower(id) {
    if (selected.includes(id)) {
        selected = selected.filter(s => s !== id);
        ranked = ranked.filter(r => r !== id);
    } else if (selected.length < 3) {
        selected.push(id);
        ranked.push(id);
    } else {
        return;
    }
    updateSelectionUI();
}

function updateSelectionUI() {
    // Update grid buttons
    POWER_TYPES.forEach(p => {
        const btn = document.getElementById("pbtn-" + p.id);
        btn.classList.remove("selected", "disabled");
        if (selected.includes(p.id)) {
            btn.classList.add("selected");
        } else if (selected.length >= 3) {
            btn.classList.add("disabled");
        }
    });

    // Update count
    document.getElementById("select-count").textContent = `(${selected.length}/3)`;

    // Update ranking
    const section = document.getElementById("ranking-section");
    const list = document.getElementById("ranking-list");

    if (ranked.length > 0) {
        section.classList.remove("hidden");
        list.innerHTML = ranked.map((id, i) => {
            const p = POWER_TYPES.find(t => t.id === id);
            return `
                <div class="rank-item" style="border-color: ${p.color}; background: ${i === 0 ? '#e8edf7' : '#f9fafb'};">
                    <div class="rank-number">${i + 1}</div>
                    <div class="rank-dot" style="background: ${p.color};"></div>
                    <div class="rank-name">${p.name}</div>
                    <div class="rank-arrows">
                        <button class="arrow-btn" onclick="moveRank(${i}, -1)" ${i === 0 ? 'disabled' : ''}>‚ñ≤</button>
                        <button class="arrow-btn" onclick="moveRank(${i}, 1)" ${i === ranked.length - 1 ? 'disabled' : ''}>‚ñº</button>
                    </div>
                </div>
            `;
        }).join("");
    } else {
        section.classList.add("hidden");
    }

    // Update submit button
    document.getElementById("submit-btn").disabled = ranked.length !== 3;
}

function moveRank(index, direction) {
    const swap = index + direction;
    if (swap < 0 || swap >= ranked.length) return;
    [ranked[index], ranked[swap]] = [ranked[swap], ranked[index]];
    updateSelectionUI();
}

// =====================================================================
// SUBMIT
// =====================================================================
async function handleSubmit() {
    if (ranked.length !== 3) return;

    const btn = document.getElementById("submit-btn");
    btn.disabled = true;
    btn.textContent = "Submitting...";

    const errorBox = document.getElementById("error-box");
    errorBox.classList.add("hidden");

    try {
        const response = await fetch(APPS_SCRIPT_URL, {
            method: "POST",
            headers: { "Content-Type": "text/plain;charset=utf-8" },
            body: JSON.stringify({
                action: "submit",
                rank1: ranked[0],
                rank2: ranked[1],
                rank3: ranked[2],
                sessionId: Date.now().toString()
            })
        });

        const data = await response.json();

        if (data.status === "success") {
            document.getElementById("submit-form").classList.add("hidden");
            document.getElementById("submit-confirm").classList.remove("hidden");

            const summary = ranked.map((id, i) => {
                const p = POWER_TYPES.find(t => t.id === id);
                return `${i + 1}. ${p.name}`;
            }).join("  ‚Ä¢  ");
            document.getElementById("confirm-summary").textContent = summary;

            submitted = true;
            setTimeout(() => loadSubmissions(), 1000);
        } else {
            throw new Error(data.message || "Unknown error");
        }

    } catch (err) {
        errorBox.textContent = "Failed to save: " + err.message + ". Please try again.";
        errorBox.classList.remove("hidden");
        btn.disabled = false;
        btn.textContent = "Submit My Top 3";
    }
}

// =====================================================================
// LOAD SUBMISSIONS
// =====================================================================
async function loadSubmissions() {
    try {
        const response = await fetch(APPS_SCRIPT_URL, {
            method: "POST",
            headers: { "Content-Type": "text/plain;charset=utf-8" },
            body: JSON.stringify({ action: "fetch" })
        });

        const data = await response.json();

        if (data.status === "success") {
            submissions = data.submissions || [];
            updateCounts();
            renderResults();
        }
    } catch (err) {
        console.log("Could not load submissions:", err);
    }
}

function updateCounts() {
    const count = submissions.length;
    document.getElementById("submission-count").textContent = count;
    document.getElementById("tab-count").textContent = count;
    document.getElementById("admin-count").textContent = count;
    document.getElementById("admin-remaining").textContent = 35 - count;
}

// =====================================================================
// RENDER RESULTS
// =====================================================================
function renderResults() {
    const empty = document.getElementById("results-empty");
    const content = document.getElementById("results-content");

    if (submissions.length === 0) {
        empty.classList.remove("hidden");
        content.classList.add("hidden");
        return;
    }

    empty.classList.add("hidden");
    content.classList.remove("hidden");

    // Calculate weighted scores
    const weighted = {};
    const voteCounts = {};
    POWER_TYPES.forEach(p => { weighted[p.id] = 0; voteCounts[p.id] = 0; });

    submissions.forEach(s => {
        s.top3.forEach((id, rank) => {
            if (weighted[id] !== undefined) {
                weighted[id] += 3 - rank; // 3pts, 2pts, 1pt
                voteCounts[id]++;
            }
        });
    });

    const results = POWER_TYPES.map(p => ({
        ...p,
        weightedScore: weighted[p.id],
        votes: voteCounts[p.id]
    })).sort((a, b) => b.weightedScore - a.weightedScore);

    const maxWeighted = Math.max(...results.map(r => r.weightedScore), 1);

    // Render bar chart
    const barsContainer = document.getElementById("bars-container");
    barsContainer.innerHTML = results.map((p, i) => `
        <div class="result-bar-card" style="border-color: ${p.color}20; border-left: 4px solid ${p.color}; background: ${i === 0 ? p.color + '08' : 'white'};">
            <div class="result-bar-header">
                <div class="result-bar-name">
                    <span style="background: ${p.color};"></span>
                    <span>${p.name}</span>
                </div>
                <div class="result-bar-score">
                    <strong>${p.weightedScore}</strong>
                    <span> pts</span>
                    <span style="font-size: 0.75rem; color: #9ca3af; margin-left: 8px;">(${p.votes} leaders)</span>
                </div>
            </div>
            <div class="result-bar-track">
                <div class="result-bar-fill" style="width: ${(p.weightedScore / maxWeighted) * 100}%; background: ${p.color};"></div>
            </div>
        </div>
    `).join("");

    // Render submissions table
    const tbody = document.getElementById("submissions-tbody");
    tbody.innerHTML = submissions.map((s, i) => {
        const cells = s.top3.map(id => {
            const p = POWER_TYPES.find(t => t.id === id);
            return `<td><span class="table-dot" style="background: ${p ? p.color : '#ccc'};"></span>${p ? p.short : id}</td>`;
        }).join("");
        return `<tr><td style="color: #9ca3af; font-size: 0.8rem;">${i + 1}</td>${cells}</tr>`;
    }).join("");

    // Render admin list
    const adminList = document.getElementById("admin-list");
    if (submissions.length > 0) {
        adminList.innerHTML = `
            <h3 style="color: #374151; margin-bottom: 12px; font-size: 1rem;">All Submissions</h3>
            ${submissions.map((s, i) => {
                const labels = s.top3.map(id => {
                    const p = POWER_TYPES.find(t => t.id === id);
                    return p ? p.short : id;
                }).join(" ‚Üí ");
                const date = s.timestamp ? new Date(s.timestamp).toLocaleDateString() : "";
                return `
                    <div style="padding: 12px 16px; border-bottom: 1px solid #f3f4f6; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <span style="font-weight: 600; color: #1f2937;">Submission ${i + 1}</span>
                            <span style="color: #9ca3af; font-size: 0.8rem; margin-left: 12px;">${labels}</span>
                        </div>
                        <span style="font-size: 0.75rem; color: #9ca3af;">${date}</span>
                    </div>
                `;
            }).join("")}
        `;
    }

    // Draw radar chart
    drawRadarChart(results);
}

// =====================================================================
// RADAR CHART
// =====================================================================
function drawRadarChart(results) {
    const canvas = document.getElementById("radarChart");
    const ctx = canvas.getContext("2d");
    const isMobile = window.innerWidth < 768;
    const size = isMobile ? Math.min(window.innerWidth - 40, 400) : 500;
    canvas.width = size;
    canvas.height = size;

    const centerX = size / 2;
    const centerY = size / 2;
    const maxRadius = isMobile ? size * 0.32 : 180;

    ctx.clearRect(0, 0, size, size);

    const maxScore = Math.max(...results.map(r => r.votes), 1);
    const scores = results.map(r => ({
        name: r.short,
        score: maxScore > 0 ? (r.votes / maxScore) * 5 : 0,
        color: r.color,
        votes: r.votes
    }));

    const numPoints = scores.length;
    const angleStep = (Math.PI * 2) / numPoints;

    // Grid circles
    ctx.strokeStyle = "#e5e7eb";
    ctx.lineWidth = 1;
    for (let i = 1; i <= 5; i++) {
        ctx.beginPath();
        ctx.arc(centerX, centerY, (maxRadius / 5) * i, 0, Math.PI * 2);
        ctx.stroke();
    }

    // Axes
    scores.forEach((_, i) => {
        const angle = angleStep * i - Math.PI / 2;
        ctx.beginPath();
        ctx.moveTo(centerX, centerY);
        ctx.lineTo(centerX + Math.cos(angle) * maxRadius, centerY + Math.sin(angle) * maxRadius);
        ctx.stroke();
    });

    // Labels
    ctx.font = isMobile ? "10px Arial" : "12px Arial";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";

    scores.forEach((item, i) => {
        const angle = angleStep * i - Math.PI / 2;
        const labelDist = isMobile ? maxRadius + 35 : maxRadius + 40;
        const lx = centerX + Math.cos(angle) * labelDist;
        const ly = centerY + Math.sin(angle) * labelDist;

        ctx.beginPath();
        ctx.fillStyle = item.color;
        ctx.arc(lx, ly - (isMobile ? 15 : 18), isMobile ? 4 : 5, 0, Math.PI * 2);
        ctx.fill();

        ctx.fillStyle = "#374151";
        const words = item.name.split(" ");
        if (words.length > 1) {
            ctx.fillText(words[0], lx, ly - 2);
            ctx.fillText(words[1] || "", lx, ly + (isMobile ? 10 : 12));
        } else {
            ctx.fillText(item.name, lx, ly);
        }
    });

    // Polygon
    ctx.beginPath();
    scores.forEach((item, i) => {
        const angle = angleStep * i - Math.PI / 2;
        const r = (item.score / 5) * maxRadius;
        const x = centerX + Math.cos(angle) * r;
        const y = centerY + Math.sin(angle) * r;
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
    });
    ctx.closePath();

    const gradient = ctx.createRadialGradient(centerX, centerY, 0, centerX, centerY, maxRadius);
    gradient.addColorStop(0, "rgba(8, 31, 93, 0.3)");
    gradient.addColorStop(1, "rgba(8, 31, 93, 0.1)");
    ctx.fillStyle = gradient;
    ctx.fill();
    ctx.strokeStyle = "#081F5D";
    ctx.lineWidth = 2.5;
    ctx.stroke();

    // Points
    scores.forEach((item, i) => {
        const angle = angleStep * i - Math.PI / 2;
        const r = (item.score / 5) * maxRadius;
        const x = centerX + Math.cos(angle) * r;
        const y = centerY + Math.sin(angle) * r;

        ctx.beginPath();
        ctx.fillStyle = "#081F5D";
        ctx.arc(x, y, isMobile ? 4 : 5, 0, Math.PI * 2);
        ctx.fill();
        ctx.strokeStyle = "#ffffff";
        ctx.lineWidth = 2;
        ctx.stroke();
    });
}

// =====================================================================
// ADMIN
// =====================================================================
function unlockAdmin() {
    const pw = document.getElementById("admin-pw").value;
    const errEl = document.getElementById("admin-pw-error");

    if (pw === "Risa44!") {
        adminUnlocked = true;
        document.getElementById("admin-lock").classList.add("hidden");
        document.getElementById("admin-panel").classList.remove("hidden");
        errEl.classList.add("hidden");
        loadSubmissions();
    } else {
        document.getElementById("admin-pw").value = "";
        errEl.textContent = "Incorrect password.";
        errEl.classList.remove("hidden");
    }
}

async function handleReset() {
    if (!confirm("This will delete ALL submissions from the Google Sheet. Are you sure?")) return;

    try {
        const response = await fetch(APPS_SCRIPT_URL, {
            method: "POST",
            headers: { "Content-Type": "text/plain;charset=utf-8" },
            body: JSON.stringify({ action: "reset", password: "Risa44!" })
        });

        const data = await response.json();

        if (data.status === "success") {
            submissions = [];
            updateCounts();
            renderResults();
            alert("All submissions have been cleared.");
        } else {
            alert("Reset failed: " + (data.message || "Unknown error"));
        }
    } catch (err) {
        alert("Reset failed. Please try again.");
    }
}
</script>
</body>
</html>
